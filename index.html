<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>日程調整アプリ</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <style>
    table, th, td { border: 1px solid #000; border-collapse: collapse; padding: 5px; }
    th { background-color: #eee; }
    .full { background-color: #ffcccc; }
  </style>
</head>
<body>
  <h2>日程調整フォーム</h2>

  <div>
    <label>ID: <input id="userId" /></label><br />
    <label>パスワード: <input id="userPassword" type="password" /></label><br />
    <button onclick="login()">ログイン/登録</button>
  </div>

  <div id="formArea" style="display:none;">
    <form id="scheduleForm">
      <table>
        <thead>
          <tr>
            <th>日付</th><th>〇</th><th>△</th><th>✕</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>5/30(金)19:00～24:00</td>
            <td><input type="radio" name="date1" value="〇" required /></td>
            <td><input type="radio" name="date1" value="△" /></td>
            <td><input type="radio" name="date1" value="✕" /></td>
          </tr>
          <tr>
            <td>6/1(土)18:00～22:00</td>
            <td><input type="radio" name="date2" value="〇" required /></td>
            <td><input type="radio" name="date2" value="△" /></td>
            <td><input type="radio" name="date2" value="✕" /></td>
          </tr>
          <tr>
            <td>6/2(日)14:00～20:00</td>
            <td><input type="radio" name="date3" value="〇" required /></td>
            <td><input type="radio" name="date3" value="△" /></td>
            <td><input type="radio" name="date3" value="✕" /></td>
          </tr>
        </tbody>
      </table>
      <label>コメント: <input name="comment" /></label><br />
      <button type="submit">送信</button>
    </form>

    <h3>みんなの回答</h3>
    <table id="answersTable">
      <thead>
        <tr>
          <th>参加者ID</th><th>5/30(金)</th><th>6/1(土)</th><th>6/2(日)</th><th>コメント</th>
        </tr>
      </thead>
      <tbody id="answersBody"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBzYCHcumBzRw3DLs8mjLiGTiXxvxmjLDU",
      authDomain: "unsoleinight-schedule.firebaseapp.com",
      projectId: "unsoleinight-schedule",
      storageBucket: "unsoleinight-schedule.appspot.com",
      messagingSenderId: "1040333692698",
      appId: "1:1040333692698:web:fb0e4f481dff8167f756a3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const scheduleId = "event1";

    window.users = {};
    window.currentUser = null;

    async function login() {
      const id = document.getElementById("userId").value.trim();
      const pw = document.getElementById("userPassword").value;

      if (!id || !pw || /[<>]/.test(id)) {
        alert("IDまたはパスワードが無効です。");
        return;
      }

      const docRef = db.collection("schedules").doc(scheduleId);
      const doc = await docRef.get();
      const data = doc.exists ? doc.data() : {};
      window.users = data.users || {};

      if (!window.users[id]) {
        window.users[id] = { password: pw, answers: {}, comment: "" };
      } else if (window.users[id].password !== pw) {
        alert("パスワードが違います。");
        return;
      }

      window.currentUser = id;
      document.getElementById("formArea").style.display = "block";
      loadPreviousAnswers();
      showAllResults();
    }

    function loadPreviousAnswers() {
      const answers = window.users[window.currentUser]?.answers || {};
      ["date1", "date2", "date3"].forEach(dateKey => {
        const val = answers[dateKey];
        if (val) {
          const el = document.querySelector(`input[name="${dateKey}"][value="${val}"]`);
          if (el) el.checked = true;
        } else {
          document.querySelectorAll(`input[name="${dateKey}"]`).forEach(el => el.checked = false);
        }
      });
      document.querySelector("[name='comment']").value = window.users[window.currentUser]?.comment || "";
    }

    document.getElementById("scheduleForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const answers = {};
      ["date1", "date2", "date3"].forEach(dateKey => {
        answers[dateKey] = document.querySelector(`input[name="${dateKey}"]:checked`)?.value || "";
      });
      const comment = document.querySelector("[name='comment']").value;

      const updateData = {
        password: window.users[window.currentUser].password,
        answers,
        comment
      };

      const prevAnswers = window.users[window.currentUser]?.answers || {};
      const changed = ["date1", "date2", "date3"].some(k => answers[k] !== prevAnswers[k]);
      if (changed) {
        updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
      }

      window.users[window.currentUser] = updateData;
      await db.collection("schedules").doc(scheduleId).set({ users: window.users });
      alert("送信しました！");
      showAllResults();
    });

    function showAllResults() {
      const tbody = document.getElementById("answersBody");
      tbody.innerHTML = "";
      const counts = { date1: 0, date2: 0, date3: 0 };

      for (const id in window.users) {
        const ans = window.users[id].answers || {};
        const comment = window.users[id].comment || "";
        if (ans.date1 === "〇") counts.date1++;
        if (ans.date2 === "〇") counts.date2++;
        if (ans.date3 === "〇") counts.date3++;

        const row = `
          <tr>
            <td>${id}</td>
            <td>${ans.date1 || ""}</td>
            <td>${ans.date2 || ""}</td>
            <td>${ans.date3 || ""}</td>
            <td>${comment}</td>
          </tr>`;
        tbody.innerHTML += row;
      }

      const headers = document.querySelectorAll("#answersTable thead th");
      ["date1", "date2", "date3"].forEach((dateKey, idx) => {
        const th = headers[idx + 1];
        th.classList.toggle("full", counts[dateKey] >= 3);
        th.textContent = th.textContent.replace(/（満員です）/g, "") +
          (counts[dateKey] >= 3 ? "（満員です）" : "");
      });
    }
  </script>
</body>
</html>
あ
