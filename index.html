<!DOCTYPE html>
<html lang="ja">
<head>
<script type="module">
  // Firebase SDK のimport
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  // Firebase設定（あなたのものを使ってね）
  const firebaseConfig = {
    apiKey: "AIzaSyBzYCHcumBzRw3DLs8mjLiGTiXxvxmjLDU",
    authDomain: "unsoleinight-schedule.firebaseapp.com",
    projectId: "unsoleinight-schedule",
    storageBucket: "unsoleinight-schedule.firebasestorage.app",
    messagingSenderId: "1040333692698",
    appId: "1:1040333692698:web:fb0e4f481dff8167f756a3"
  };

  // Firebase初期化
  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();
  const provider = new GoogleAuthProvider();

  // グローバル変数（ログインユーザーのUID）
  let currentUserUid = null;

  // Googleログイン関数
  window.googleLogin = () => {
    signInWithPopup(auth, provider)
      .then((result) => {
        currentUserUid = result.user.uid;
        document.getElementById("welcomeMsg").textContent = `${result.user.displayName} さんとしてログイン中`;
        toggleSections(true);
        loadPreviousAnswers();
        showAllResults();
      })
      .catch((error) => {
        alert("ログインエラー：" + error.message);
      });
  };

  // ログアウト関数
  window.logout = () => {
    signOut(auth).then(() => {
      location.reload();
    });
  };

  // ログイン状態監視
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUserUid = user.uid;
      document.getElementById("welcomeMsg").textContent = `${user.displayName} さんとしてログイン中`;
      toggleSections(true);
      loadPreviousAnswers();
      showAllResults();
    } else {
      toggleSections(false);
    }
  });

  // セクション表示切替（ログイン済みならフォーム・結果表示、未ログインならログイン画面）
  function toggleSections(loggedIn) {
    if(loggedIn){
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("formSection").classList.remove("hidden");
      document.getElementById("resultSection").classList.remove("hidden");
    } else {
      document.getElementById("loginSection").classList.remove("hidden");
      document.getElementById("formSection").classList.add("hidden");
      document.getElementById("resultSection").classList.add("hidden");
      document.getElementById("welcomeMsg").textContent = "";
    }
  }

  // Firestoreからログインユーザーの以前の回答を取得してフォームに反映
  async function loadPreviousAnswers() {
    if (!currentUserUid) return;
    const docRef = doc(db, "schedules", currentUserUid);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const data = docSnap.data();
      if(data.answers && data.answers.date1){
        document.querySelector(`input[name="date1"][value="${data.answers.date1}"]`).checked = true;
      }
      document.getElementById("comment").value = data.comment || "";
    }
  }

  // Firestoreに回答を保存
  async function saveAnswers(answers, comment) {
    if (!currentUserUid) return;
    const docRef = doc(db, "schedules", currentUserUid);
    await setDoc(docRef, { answers, comment });
  }

  // 全ユーザーの回答をFirestoreから取得してテーブル表示
  async function showAllResults() {
    const tbody = document.getElementById("resultTable").querySelector("tbody");
    tbody.innerHTML = "";
    const querySnapshot = await getDocs(collection(db, "schedules"));
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const answers = data.answers || {};
      const comment = data.comment || "";
      // ユーザーIDはdoc.id
      const row = `
        <tr>
          <td>${doc.id}</td>
          <td>${answers.date1 || "-"}</td>
          <td>${comment}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
  }

  // フォームの送信処理
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById("scheduleForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUserUid) {
        alert("ログインしてください！");
        return;
      }
      const result1 = document.querySelector('input[name="date1"]:checked')?.value;
      const comment = document.getElementById("comment").value;

      if (!result1) {
        alert("日程の選択をしてください！");
        return;
      }

      await saveAnswers({ date1: result1 }, comment);
      document.getElementById("submitMessage").textContent = "回答を保存しました！";
      showAllResults();
    });
  });

</script>

  <meta charset="UTF-8">
  <title>日程調整アンケート</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f0f8ff;
      padding: 20px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #aaa;
      margin-bottom: 30px;
    }
    .hidden {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px;
    }
    th {
      background-color: #e0f0ff;
    }
    textarea {
      width: 100%;
      height: 60px;
    }
  </style>
</head>
<body>

<!-- ログイン画面 -->
<div class="container" id="loginSection">
  <h2>ログイン</h2>
  <button onclick="googleLogin()">Googleでログイン</button>
</div>

<!-- アンケート画面 -->
<div class="container hidden" id="formSection">
  <h2>日程調整アンケート</h2>
  <p id="welcomeMsg"></p>
  <form id="scheduleForm">
    <table>
      <thead>
        <tr>
          <th>日付</th>
          <th>〇</th>
          <th>△</th>
          <th>✕</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>5/30(金)19:00～24:00</td>
          <td><input type="radio" name="date1" value="〇" required></td>
          <td><input type="radio" name="date1" value="△"></td>
          <td><input type="radio" name="date1" value="✕"></td>
        </tr>
      </tbody>
    </table>
    <br>
    <label for="comment">コメント（任意）:</label><br>
    <textarea id="comment" placeholder="例：午後ならOKです！など"></textarea><br><br>
    <button type="submit">送信・更新</button>
    <p id="submitMessage" style="color:green;"></p>
  </form>
  <button onclick="logout()">ログアウト</button>
</div>

<!-- 全体の集計表示 -->
<div class="container hidden" id="resultSection">
  <h2>全員の回答一覧</h2>
  <table id="resultTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>5/30(金)19:00～24:00</th>
        <th>コメント</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</body>
</html>
